<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Munchies Halloween Hunt üéÉ</title>
<link rel="preconnect" href="https://cdn.jsdelivr.net" />
<style>
  :root { --fg:#fff; --bg:#0b0b12; --accent:#ff5a00; --muted:#8e8ea0; }
  html,body { margin:0; background:var(--bg); color:var(--fg); font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu; }
  .wrap { max-width:860px; margin:0 auto; padding:24px 16px 120px; }
  .card { background:#111423; border:1px solid #22253a; border-radius:16px; padding:20px; box-shadow:0 10px 30px rgba(0,0,0,.35); }
  h1 { margin:0 0 8px; font-size:28px; }
  h2 { margin:16px 0 8px; font-size:20px; }
  .sub { color:var(--muted); margin:0 0 18px; }
  .row { display:flex; gap:12px; flex-wrap:wrap; margin:12px 0; }
  input,button,select { font-size:16px; padding:12px 14px; border-radius:12px; border:1px solid #2a2d44; background:#0f1222; color:var(--fg); }
  button { background:var(--accent); border:none; color:#111; font-weight:700; cursor:pointer; }
  button:disabled { opacity:.6; cursor:not-allowed; }
  .progress { height:12px; background:#1a1d31; border-radius:999px; overflow:hidden; margin:12px 0 4px; }
  .bar { height:100%; width:0%; background:linear-gradient(90deg,#ff5a00,#ffae00); transition:width .4s ease; }
  .list { margin:14px 0; padding:0; list-style:none; }
  .tag { padding:10px 12px; border:1px solid #2a2d44; border-radius:12px; margin:8px 0; display:flex; align-items:center; justify-content:space-between; }
  .tag small { color:var(--muted); }
  .ok { color:#2ee26d; font-weight:700; }
  .warn { color:#ffae00; }
  .footer { position:fixed; left:0; right:0; bottom:0; padding:14px; background:rgba(11,11,18,.9); border-top:1px solid #22253a; display:flex; gap:10px; justify-content:center; }
  .pill { font-size:12px; padding:4px 8px; border-radius:999px; background:#1e223a; border:1px solid #2a2d44; }
  /* Leaderboard */
  .lb { text-align:center; }
  .lb h1 { font-size:40px; }
  .tbl { width:100%; border-collapse:collapse; margin-top:16px; }
  .tbl th,.tbl td { border-bottom:1px solid #22253a; padding:12px; font-size:20px; }
  .tbl th { text-align:left; color:#cfcfe4; font-weight:600; }
  .big { font-size:48px; font-weight:800; }
  .right { text-align:right; }
  @media (min-width:900px){ .wrap{max-width:1100px;} }

  /* Simple modal for anon key input */
  .modal { position:fixed; inset:0; background:rgba(0,0,0,.7); display:flex; align-items:center; justify-content:center; }
  .modal .inner { background:#151833; border:1px solid #2a2d44; border-radius:16px; padding:20px; width:min(560px,92%); }
</style>
</head>
<body>
  <div class="wrap">
    <div class="card" id="app"></div>
  </div>

  <div class="footer" id="footer"></div>

  <div class="modal" id="keyModal" style="display:none;">
    <div class="inner">
      <h2>Enter Supabase anon key</h2>
      <p class="sub">Paste your project's <strong>anon public</strong> key. It will be stored only on this device (localStorage).</p>
      <div class="row">
        <input id="anonInput" placeholder="eyJhbGciOiJIUzI1NiIs..." />
        <button id="saveAnon">Save</button>
      </div>
      <small class="sub">Tip: You can also append <code>?setkey=YOUR_KEY_HERE</code> to the URL once and it will save automatically.</small>
    </div>
  </div>

<script type="module">
import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm";

const SUPABASE_URL = "https://oeahpsbnazvijogyxedu.supabase.co";
let SUPABASE_KEY = "ASK_AT_RUNTIME"; // stored in localStorage

// Accept anon key via URL param once (?setkey=...)
const p = new URLSearchParams(location.search);
const keyFromQS = p.get("setkey");
if (keyFromQS) { localStorage.setItem("hunt_sb_key", keyFromQS); SUPABASE_KEY = keyFromQS; history.replaceState({}, "", location.origin + location.pathname + location.hash); }
if (!SUPABASE_KEY || SUPABASE_KEY === "ASK_AT_RUNTIME") { SUPABASE_KEY = localStorage.getItem("hunt_sb_key") || ""; }

const keyModal = document.getElementById("keyModal");
if (!SUPABASE_KEY) {
  keyModal.style.display = "flex";
  document.getElementById("saveAnon").onclick = ()=>{
    const val = (document.getElementById("anonInput").value||"").trim();
    if (!val) return;
    localStorage.setItem("hunt_sb_key", val);
    location.reload();
  };
}

const sb = createClient(SUPABASE_URL, SUPABASE_KEY);

const $ = (id)=>document.getElementById(id);
const q = new URLSearchParams(location.search);
const view = (q.get("view")||"play").toLowerCase();
const tagFromURL = q.get("tag");

let playerId = localStorage.getItem("hunt_player_id");

/* ========= Profanity + World-Leader Filter ========= */
const bannedWords = [
  // Common profanity
  "fuck","shit","bitch","cunt","asshole","bastard","dick","cock","pussy",
  "twat","slut","whore","prick","bollocks","bugger","arse","damn",
  "goddamn","hell",

  // Sexual/explicit
  "handjob","blowjob","dildo","clit","penis","vagina","cum","jizz","jism",
  "spunk","orgasm","rape","rapist","molest","incest","pedo","pedophile",

  // Racist / homophobic slurs
  "nigger","nigga","chink","spic","kike","faggot","tranny","dyke","gook",
  "coon","wetback","raghead","paki","jap","slant","zipperhead","gypsy",

  // Variations / masked spellings
  "fuk","f*ck","f#ck","sh1t","biatch","btch","azzhole","a$$hole","c0ck",
  "dik","pusy","phuck","phuk","mofo","m0f0","wtf","stfu",

  // World leaders & dictators (historic + current)
  "hitler","stalin","mussolini","putin","lenin","mao","kim jong","kim jong un",
  "xi jinping","trump","donald trump","biden","joe biden","obama","barack",
  "bush","george bush","reagan","ronald reagan","saddam","saddam hussein",
  "bin laden","osama","gaddafi","qaddafi","pol pot","castro","fidel",
  "che guevara","ayatollah","netanyahu","modi","erdogan","bolsonaro",
  "duarte","assad","mohammed bin","king jong"
];

function hasProfanity(str){ if (!str) return false; const low = str.toLowerCase(); return bannedWords.some(w => low.includes(w)); }
function sanitizeName(str){ if (!str) return ""; return hasProfanity(str) ? "" : str; }
function safeDisplayName(name, id){ const n = sanitizeName(name); return n && n.trim() ? n : String(id).slice(0,8); }

function showStatus(msg, kind="ok", target="app"){ const box = document.createElement("div"); box.innerHTML = `<p class="${kind==='ok'?'ok':'warn'}">${msg}</p>`; $(target).appendChild(box); setTimeout(()=>box.remove(), 3000); }

/* ===== Player ===== */
async function ensurePlayer() {
  if (playerId) return playerId;
  const { data, error } = await sb.from("players").insert({}).select("id").single();
  if (error) { showStatus("Could not create player. Refresh.","warn"); return null; }
  playerId = data.id; localStorage.setItem("hunt_player_id", playerId); return playerId;
}

async function getTags() { const { data } = await sb.from("tags").select("*").eq("active", true).order("id"); return data || []; }
async function getFindsForPlayer(pid) { const { data } = await sb.from("finds").select("tag_id").eq("player_id", pid); return (data||[]).map(x=>x.tag_id); }

function renderPlayerUI(tags, foundSet){
  const total = tags.length;
  const foundCount = tags.filter(t=>foundSet.has(t.id)).length;
  const totalPoints = tags.reduce((a,t)=>a+(t.points||0),0);
  const earned = tags.filter(t=>foundSet.has(t.id)).reduce((a,t)=>a+(t.points||0),0);
  const pct = total? Math.round((foundCount/total)*100) : 0;

  document.getElementById("app").innerHTML = `
    <h1>üéÉ Munchies Halloween Hunt</h1>
    <p class="sub">Tap tokens with your phone or scan the QR. Collect points. Redeem at the truck.</p>

    <div class="progress"><div class="bar" style="width:${pct}%"></div></div>
    <small>${foundCount} / ${total} found ‚Ä¢ ${earned}/${totalPoints} pts</small>

    <div class="row" id="playerInputs">
      <input id="nickname" placeholder="Nickname (optional)" />
      <input id="phone" placeholder="Phone for prize text (optional)" inputmode="tel" />
      <button id="savePlayer">Save</button>
    </div>

    <ul class="list" id="tagList"></ul>
  `;
  const list = document.getElementById("tagList");
  tags.forEach(t=>{
    const found = foundSet.has(t.id);
    const li = document.createElement("li");
    li.className="tag";
    li.innerHTML = `
      <div>
        <strong>${t.label || t.id}</strong><br/>
        <small>${found?`+${t.points||0} pts`:`${t.points||0} pts available`}</small>
      </div>
      <div>${found? "‚úÖ" : "üßü‚Äç‚ôÇÔ∏è"}</div>
    `;
    list.appendChild(li);
  });

  document.getElementById("savePlayer").onclick = async ()=>{
    let nickname = (document.getElementById("nickname").value||"").trim();
    const phone = (document.getElementById("phone").value||"").trim();
    const cleaned = sanitizeName(nickname);
    if (!cleaned && nickname) showStatus("Nickname blocked (not allowed).","warn");
    await sb.from("players").update({ nickname: cleaned, phone }).eq("id", playerId);
    showStatus("Saved.");
  };

  document.getElementById("footer").innerHTML = `
    <button id="claimBtn">üëª I‚Äôm at a token ‚Äî Log it</button>
    <button id="redeemBtn">üç¶ Redeem at Truck</button>
  `;
  document.getElementById("claimBtn").onclick = async ()=>{
    const manual = prompt("Enter the code on the token (e.g., GRAVEYARD-03):");
    if (manual) await claimToken(manual.trim().toUpperCase());
  };
  document.getElementById("redeemBtn").onclick = ()=>{ alert("Show this screen to Munchies staff. They‚Äôll verify points & award your treat! üç¶"); };
}

function distanceMeters(lat1,lon1,lat2,lon2){
  const R=6371e3, toRad=v=>v*Math.PI/180;
  const dLat=toRad(lat2-lat1), dLon=toRad(lon2-lon1);
  const a=Math.sin(dLat/2)**2 + Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)**2;
  return 2*R*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));
}

async function claimToken(tagId){
  const { data: prior } = await sb.from("finds").select("id").eq("player_id", playerId).eq("tag_id", tagId).maybeSingle();
  if (prior) { showStatus("Already logged this token.","warn"); return; }
  const { data: trow } = await sb.from("tags").select("*").eq("id", tagId).maybeSingle();
  if (!trow || !trow.active) { showStatus("Invalid or inactive token.","warn"); return; }
  try {
    if (trow.lat && trow.lng && navigator.geolocation) {
      const pos = await new Promise((res, rej)=>navigator.geolocation.getCurrentPosition(res, rej, {timeout:4000}));
      const d = distanceMeters(pos.coords.latitude, pos.coords.longitude, trow.lat, trow.lng);
      if (d > 150) showStatus("You seem far from this token. Staff may verify.","warn");
    }
  } catch(_) {}
  const { error } = await sb.from("finds").insert({ player_id: playerId, tag_id: tagId, score_awarded: trow.points||0 });
  if (error) { showStatus("Error logging token.","warn"); return; }
  showStatus(`Logged: ${trow.label || tagId} (+${trow.points||0} pts)`);
  await initPlay();
}

async function initPlay(){
  await ensurePlayer();
  if (tagFromURL) { await claimToken(tagFromURL); history.replaceState({}, "", location.origin + location.pathname); }
  const [tags, finds] = await Promise.all([getTags(), getFindsForPlayer(playerId)]);
  renderPlayerUI(tags, new Set(finds));
}

/* ===== Admin ===== */
async function requireAdminSession(){
  const { data: { user } } = await sb.auth.getUser();
  if (user) return user;
  renderAdminLogin();
  throw new Error("no-session");
}

function renderAdminLogin(){
  document.getElementById("app").innerHTML = `
    <h1>üßõ Admin Login</h1>
    <p class="sub">Enter your email. We‚Äôll send a magic link/OTP.</p>
    <div class="row">
      <input id="adminEmail" placeholder="you@domain.com" inputmode="email" />
      <button id="sendOtp">Send Code</button>
    </div>
    <div class="row">
      <input id="otpToken" placeholder="6-digit code" inputmode="numeric" />
      <button id="verifyOtp">Verify</button>
    </div>
  `;
  document.getElementById("footer").innerHTML = `<span class="pill">Tip: Add your email to the admins table.</span>`;
  document.getElementById("sendOtp").onclick = async ()=>{
    const email = (document.getElementById("adminEmail").value||"").trim();
    if (!email) return;
    const { error } = await sb.auth.signInWithOtp({ email, options:{ emailRedirectTo: location.href } });
    if (error) return showStatus("Error sending code.","warn");
    showStatus("Check your email for the code.");
  };
  document.getElementById("verifyOtp").onclick = async ()=>{
    const email = (document.getElementById("adminEmail").value||"").trim();
    const token = (document.getElementById("otpToken").value||"").trim();
    if (!email || !token) return;
    const { error } = await sb.auth.verifyOtp({ email, token, type:"email" });
    if (error) return showStatus("Invalid code.","warn");
    showStatus("Logged in.");
    initAdmin();
  };
}

async function adminStats(){
  const [{ data: tagCount }, { data: playerCount }, { data: finds }] = await Promise.all([
    sb.from("tags").select("id", { count:"exact", head:true }),
    sb.from("players").select("id", { count:"exact", head:true }),
    sb.from("finds").select("score_awarded")
  ]);
  const totalFinds = finds?.length||0;
  const totalPoints = (finds||[]).reduce((a,f)=>a+(f.score_awarded||0),0);
  return { tagCount: tagCount?.length||0, playerCount: playerCount?.length||0, totalFinds, totalPoints };
}

async function listTags() { const { data } = await sb.from("tags").select("*").order("id"); return data||[]; }
async function upsertTag(row){ const { error } = await sb.from("tags").upsert(row); if (error) showStatus("Save failed.","warn"); }
async function deleteTag(id){ const { error } = await sb.from("tags").delete().eq("id", id); if (error) showStatus("Delete failed.","warn"); }
async function recentFinds(limit=25){
  const { data } = await sb.rpc("recent_finds_with_names", { limit_count: limit }).catch(()=>({data:null}));
  if (data) return data;
  const { data: rows } = await sb.from("finds").select("found_at, score_awarded, tag_id, player_id").order("found_at",{ascending:false}).limit(limit);
  return rows||[];
}

async function initAdmin(){
  try { await requireAdminSession(); } catch { return; }
  const stats = await adminStats();
  const tags = await listTags();
  document.getElementById("app").innerHTML = `
    <h1>üßõ Admin</h1>
    <p class="sub">Mobile-friendly controls. Only whitelisted admins can write.</p>

    <div class="row">
      <span class="pill">Tags: ${'${stats.tagCount}'}</span>
      <span class="pill">Players: ${'${stats.playerCount}'}</span>
      <span class="pill">Finds: ${'${stats.totalFinds}'}</span>
      <span class="pill">Points: ${'${stats.totalPoints}'}</span>
    </div>

    <h2>Tags</h2>
    <div id="tagEditor"></div>

    <h2>Live Finds</h2>
    <ul class="list" id="findFeed"></ul>
  `;
  renderTagEditor(tags);
  streamFinds();
  document.getElementById("footer").innerHTML = `
    <button id="addTag">‚ûï New Tag</button>
    <button id="signOut">üö™ Sign Out</button>
  `;
  document.getElementById("addTag").onclick = ()=> renderTagRow({ id:"", label:"", points:10, active:true }, true);
  document.getElementById("signOut").onclick = async ()=>{ await sb.auth.signOut(); location.reload(); };
}

function renderTagEditor(tags){
  const host = document.getElementById("tagEditor");
  host.innerHTML = "";
  tags.forEach(t=>renderTagRow(t,false,host));
}

function renderTagRow(t,isNew=false,host=document.getElementById("tagEditor")){
  const row = document.createElement("div");
  row.className="row";
  row.style.alignItems="center";
  row.innerHTML = `
    <input style="min-width:120px" placeholder="ID (GRAVEYARD-03)" value="${'${t.id||""}'}" ${'${!isNew?"disabled":""}'} />
    <input style="min-width:140px" placeholder="Label" value="${'${t.label||""}'}" />
    <input style="width:100px" placeholder="Points" inputmode="numeric" value="${'${t.points??10}'}" />
    <select>
      <option value="true" ${'${t.active?"selected":""}'}>Active</option>
      <option value="false" ${'${!t.active?"selected":""}'}>Inactive</option>
    </select>
    <button>${'${isNew?"Save":"Update"}'}</button>
    ${'${!isNew?'<button data-del="1">Delete</button>':""}'}
  `;
  const inputs = row.querySelectorAll("input,select,button");
  const idI=inputs[0], labelI=inputs[1], ptsI=inputs[2], actS=inputs[3], saveB=inputs[4], delB=inputs[5];
  saveB.onclick = async ()=>{
    const rowData = {
      id: (idI.value||"").trim().toUpperCase(),
      label: (labelI.value||"").trim(),
      points: parseInt(ptsI.value||"10",10),
      active: actS.value==="true"
    };
    if (!rowData.id) return showStatus("ID required.","warn");
    await upsertTag(rowData);
    showStatus("Saved.");
    initAdmin();
  };
  if (delB){
    delB.onclick = async ()=>{
      if (!confirm(`Delete ${'${t.id}'}?`)) return;
      await deleteTag(t.id);
      showStatus("Deleted.");
      initAdmin();
    };
  }
  host.appendChild(row);
}

async function streamFinds(){
  const feed = document.getElementById("findFeed");
  const draw = (rows)=>{
    feed.innerHTML = "";
    rows.forEach(r=>{
      const li = document.createElement("li");
      li.className="tag";
      const who = r.player ? safeDisplayName(r.player, r.player) : safeDisplayName("", r.player_id);
      li.innerHTML = `
        <div><strong>${'${r.tag_id}'} </strong><br><small>${'${new Date(r.found_at).toLocaleTimeString()}'} </small></div>
        <div>+${'${r.score_awarded||0}'} <span class="pill">${'${who}'}</span></div>
      `;
      feed.appendChild(li);
    });
  };
  draw(await recentFinds(25));
  try {
    sb.channel("finds_changes")
      .on("postgres_changes", { event: "INSERT", schema:"public", table:"finds" }, async (_payload)=>{ draw(await recentFinds(25)); })
      .subscribe();
  } catch(_){}
}

/* ===== Leaderboard ===== */
async function getLeaderboard(limit=20){
  const { data } = await sb.from("finds").select("player_id, score_awarded").order("found_at", { ascending:false });
  const scores = new Map();
  (data||[]).forEach(r=>{ scores.set(r.player_id, (scores.get(r.player_id)||0) + (r.score_awarded||0)); });
  const ids = Array.from(scores.keys()); let names = {};
  if (ids.length) {
    const { data: players } = await sb.from("players").select("id, nickname").in("id", ids);
    (players||[]).forEach(p=>{ names[p.id] = p.nickname || ""; });
  }
  const rows = ids.map(id=>({ player:id, name:safeDisplayName(names[id], id), points:scores.get(id) }))
    .sort((a,b)=>b.points-a.points).slice(0, limit);
  return rows;
}

async function initLeaderboard(){
  document.getElementById("app").innerHTML = `
    <div class="lb">
      <h1>üëª Halloween Hunt Leaderboard</h1>
      <div id="lbTotals" class="row" style="justify-content:center"></div>
      <table class="tbl" id="lbTable">
        <thead><tr><th>#</th><th>Player</th><th class="right">Points</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  `;
  document.getElementById("footer").innerHTML = `<button id="refresh">üîÑ Refresh</button> <button id="fit">üñ•Ô∏è Fullscreen</button>`;
  document.getElementById("refresh").onclick = drawLeaderboard;
  document.getElementById("fit").onclick = ()=>{ if (document.fullscreenElement) document.exitFullscreen(); else document.documentElement.requestFullscreen().catch(()=>{}); };
  await drawLeaderboard();
  setInterval(drawLeaderboard, 15000);
}

async function drawLeaderboard(){
  const rows = await getLeaderboard(20);
  const tbody = document.getElementById("lbTable").querySelector("tbody");
  tbody.innerHTML = "";
  rows.forEach((r, i)=>{
    const tr = document.createElement("tr");
    tr.innerHTML = `<td>${'${i+1}'}</td><td>${'${r.name}'}</td><td class="right big">${'${r.points}'}</td>`;
    tbody.appendChild(tr);
  });
  const { data: finds } = await sb.from("finds").select("score_awarded");
  const totalPoints = (finds||[]).reduce((a,f)=>a+(f.score_awarded||0),0);
  document.getElementById("lbTotals").innerHTML = `<span class="pill">Total Points: ${'${totalPoints}'}</span> <span class="pill">Players on board: ${'${rows.length}'}</span>`;
}

/* ===== Router ===== */
(async function main(){
  if (!SUPABASE_KEY) return; // wait for anon key entry
  if (view === "admin") return initAdmin();
  if (view === "leaderboard") return initLeaderboard();
  return initPlay();
})();
</script>
</body>
</html>
