
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Munchies Halloween Hunt</title>
  <style>
    body { background:#0d0d0d; color:#fff; font-family:sans-serif; margin:0; }
    header { background:#1a1a1a; padding:10px; display:flex; justify-content:space-around; }
    header button { background:#ff6600; border:none; padding:10px 20px; border-radius:6px; font-weight:bold; cursor:pointer; }
    header button.active { background:#ffaa33; }
    section { display:none; padding:20px; }
    section.active { display:block; }
    .toast { position:fixed; bottom:10px; right:10px; background:#333; padding:10px; border-radius:5px; }
    input, button, textarea, select { margin:5px 0; padding:8px; }
    .muted { color:#bbb; font-size:12px; }
    .row { display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
    table { width:100%; border-collapse:collapse; margin-top:8px; }
    th, td { border-bottom:1px solid #2a2a2a; padding:8px; text-align:left; }
    td.right { text-align:right }
    .pill { background:#222; border:1px solid #333; padding:4px 8px; border-radius:999px; font-size:12px; }
  </style>
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
</head>
<body>
  <header>
    <button onclick="show('play')" id="btn-play">Play</button>
    <button onclick="show('admin')" id="btn-admin">Admin</button>
    <button onclick="show('leaderboard')" id="btn-leaderboard">Leaderboard</button>
  </header>

  <section id="play" class="active">
    <h2>🎃 Player View</h2>
    <label>Nickname: <input id="nickname" placeholder="Enter nickname"/></label>
    <button onclick="saveNickname()">Save</button>
    <div><button onclick="claimTag()">👻 Log a token</button></div>
    <div id="progress" class="muted"></div>
  </section>

  <section id="admin">
    <h2>🔐 Admin Login (Password)</h2>
    <div id="admin-login">
      <div class="row">
        <input id="admin-email" placeholder="Email" autocomplete="username"/>
        <input id="admin-pass" placeholder="Password" type="password" autocomplete="current-password"/>
        <button onclick="loginPassword()">Login</button>
      </div>
      <div class="muted">Only whitelisted accounts can manage tags & points. Password login only.</div>
    </div>
    <div id="admin-panel" style="display:none;">
      <div class="row">
        <button onclick="signOut()">🚪 Sign out</button>
        <span id="whoami" class="pill"></span>
      </div>

      <h3>Players (adjust points)</h3>
      <div class="row">
        <input id="searchName" placeholder="Search nickname"/>
        <button onclick="loadPlayers()">Search</button>
        <button onclick="loadPlayers(true)" title="Show all">Show all</button>
      </div>
      <table>
        <thead>
          <tr><th>Player</th><th class="right">Points</th><th>Δ (e.g. -5 or 10)</th><th>Reason</th><th></th></tr>
        </thead>
        <tbody id="playersTable"></tbody>
      </table>

      <h3>Tags</h3>
      <div id="tag-list"></div>

      <h3>Live Finds</h3>
      <div id="live-finds"></div>
    </div>
  </section>

  <section id="leaderboard">
    <h2>👻 Leaderboard</h2>
    <div id="leaders"></div>
  </section>

  <div id="toast" class="toast" style="display:none;"></div>

<script>
const SUPABASE_URL = "https://oeahpsbnazvijogyxedu.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9lYWhwc2JuYXp2aWpvZ3l4ZWR1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc2MzIxMDQsImV4cCI6MjA3MzIwODEwNH0.FFx6EfbVu2FGGdsfLHGAUASSfsek679Q1z5gDcYqaPE"; // baked-in anon public key
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

let playerId = localStorage.getItem('player_id');
let adminUser = null;

async function ensurePlayer() {
  if (!playerId) {
    let { data, error } = await supabase.from('players').insert({}).select().single();
    if (error) { console.error(error); toast("Player create failed"); return; }
    playerId = data.id;
    localStorage.setItem('player_id', playerId);
  }
  loadProgress();
}
ensurePlayer();

function show(view) {
  document.querySelectorAll('section').forEach(s => s.classList.remove('active'));
  document.getElementById(view).classList.add('active');
  document.querySelectorAll('header button').forEach(b=>b.classList.remove('active'));
  document.getElementById('btn-'+view).classList.add('active');
  if(view==='leaderboard') loadLeaderboard();
  if(view==='admin') checkAdminSession();
}

// --- Player actions ---
async function saveNickname(){
  const nickname = document.getElementById('nickname').value;
  await supabase.from('players').update({nickname}).eq('id',playerId);
  toast("Nickname saved");
  loadLeaderboard();
}

async function claimTag(){
  const code = prompt("Enter tag id (e.g., GRAVEYARD-01)");
  if(!code) return;
  await ensurePlayer();
  const tag = await supabase.from('tags').select('*').eq('id', code).maybeSingle();
  if(!tag.data) return toast("Tag not found");
  const pts = tag.data.points || 0;
  const { error } = await supabase.from('finds').insert({ player_id:playerId, tag_id:code, score_awarded: pts });
  if(error) toast("Error: "+error.message);
  else { toast(`Logged ${code} (+${pts} pts)`); loadProgress(); loadLeaderboard(); }
}

async function loadProgress(){
  const tags = await supabase.from('tags').select('*').eq('active', true);
  const finds = await supabase.from('finds').select('tag_id, score_awarded').eq('player_id', playerId);
  const total = (tags.data||[]).length;
  const found = new Set((finds.data||[]).map(f=>f.tag_id)).size;
  const points = (finds.data||[]).reduce((a,f)=>a+(f.score_awarded||0),0);
  document.getElementById('progress').innerText = `Found: ${found} / ${total} • Points: ${points}`;
}

// --- Leaderboard with adjustments ---
async function loadLeaderboard(){
  // aggregate finds
  const finds = await supabase.from('finds').select('player_id, score_awarded');
  if(finds.error) { console.error(finds.error); return; }
  const scores = new Map();
  (finds.data||[]).forEach(r=>{
    const key = String(r.player_id);
    scores.set(key,(scores.get(key)||0)+(r.score_awarded||0));
  });

  // aggregate adjustments
  const adj = await supabase.from('adjustments').select('player_id, delta');
  if(!adj.error){
    (adj.data||[]).forEach(a=>{
      const key = String(a.player_id);
      scores.set(key,(scores.get(key)||0)+(a.delta||0));
    });
  }

  const ids = Array.from(scores.keys());
  if(ids.length===0) { document.getElementById('leaders').innerHTML = "<div class='muted'>No plays yet</div>"; return; }

  const players = await supabase.from('players').select('id,nickname').in('id', ids);
  let names = {};
  if(players.error) { console.warn("players read error:", players.error); }
  (players.data||[]).forEach(p=> names[String(p.id)] = p.nickname || "");

  const arr = ids.map(id=>({ id, name: names[id]||id.slice(0,8), pts: scores.get(id) }))
                 .sort((a,b)=>b.pts-a.pts).slice(0,50);
  document.getElementById('leaders').innerHTML = arr.map((r,i)=>`<div>${i+1}. <b>${r.name}</b> — ${r.pts} pts</div>`).join("");
}

// --- Admin (password) ---
async function loginPassword(){
  const email = document.getElementById('admin-email').value.trim();
  const password = document.getElementById('admin-pass').value;
  if(!email || !password){ toast("Enter email & password"); return; }
  const { data, error } = await supabase.auth.signInWithPassword({ email, password });
  if(error){ toast("Login failed: "+error.message); return; }
  await checkAdminSession();
}

async function checkAdminSession(){
  const { data: { user } } = await supabase.auth.getUser();
  if(!user){
    document.getElementById('admin-panel').style.display='none';
    document.getElementById('admin-login').style.display='block';
    return;
  }
  adminUser = user;
  document.getElementById('whoami').innerText = user.email;
  // verify admin
  const admin = await supabase.from('admins').select('user_id').eq('user_id', user.id).maybeSingle();
  if(!admin.data){
    toast("This account is not whitelisted as admin");
    await supabase.auth.signOut();
    document.getElementById('admin-panel').style.display='none';
    document.getElementById('admin-login').style.display='block';
    return;
  }
  document.getElementById('admin-login').style.display='none';
  document.getElementById('admin-panel').style.display='block';
  await Promise.all([loadAdmin(), loadPlayers(true)]);
}

async function signOut(){
  await supabase.auth.signOut();
  document.getElementById('admin-panel').style.display='none';
  document.getElementById('admin-login').style.display='block';
}

// --- Admin data ---
async function loadAdmin(){
  const tags = await supabase.from('tags').select('*').order('id');
  document.getElementById('tag-list').innerHTML = (tags.data||[]).map(t=>`<div>${t.id} — ${t.label||''} (${t.points||0} pts)</div>`).join("");
  const finds = await supabase.from('finds').select('found_at, tag_id, score_awarded').order('found_at', { ascending:false }).limit(10);
  document.getElementById('live-finds').innerHTML = (finds.data||[]).map(f=>`<div>${new Date(f.found_at).toLocaleTimeString()} — ${f.tag_id} (+${f.score_awarded})</div>`).join("");
}

// --- Admin: player list + adjustments ---
function sumBy(arr, key){ return (arr||[]).reduce((a,x)=>a+(x[key]||0),0); }

async function loadPlayers(showAll=false){
  // get base players (limit for perf)
  const q = supabase.from('players').select('id,nickname').order('created_at',{ascending:false});
  let players;
  const term = document.getElementById('searchName').value.trim();
  if(showAll){ players = await q.limit(200); }
  else if(term){ players = await supabase.from('players').select('id,nickname').ilike('nickname', `%${term}%`).limit(100); }
  else { players = await q.limit(50); }

  if(players.error){ document.getElementById('playersTable').innerHTML = "<tr><td colspan='5'>Error loading players</td></tr>"; return; }
  const ids = (players.data||[]).map(p=>p.id);
  if(ids.length===0){ document.getElementById('playersTable').innerHTML = "<tr><td colspan='5' class='muted'>No players found</td></tr>"; return; }

  // aggregate points from finds + adjustments
  const [f, a] = await Promise.all([
    supabase.from('finds').select('player_id, score_awarded').in('player_id', ids),
    supabase.from('adjustments').select('player_id, delta').in('player_id', ids)
  ]);
  const findsBy = new Map(); (f.data||[]).forEach(x=> findsBy.set(x.player_id, (findsBy.get(x.player_id)||0)+(x.score_awarded||0)));
  const adjBy = new Map(); (a.data||[]).forEach(x=> adjBy.set(x.player_id, (adjBy.get(x.player_id)||0)+(x.delta||0)));

  const tbody = document.getElementById('playersTable');
  tbody.innerHTML = "";
  (players.data||[]).forEach(p=>{
    const base = findsBy.get(p.id)||0;
    const extra = adjBy.get(p.id)||0;
    const total = base + extra;
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${p.nickname||p.id.slice(0,8)}</td>
      <td class="right"><b>${total}</b> <span class="muted">(tags: ${base} / adj: ${extra})</span></td>
      <td><input type="number" step="1" value="0" style="width:90px" /></td>
      <td><input type="text" placeholder="Reason (optional)" style="min-width:180px" /></td>
      <td><button>Apply</button></td>
    `;
    const [deltaI, reasonI, btn] = [tr.children[2].children[0], tr.children[3].children[0], tr.children[4].children[0]];
    btn.onclick = async ()=>{
      const delta = parseInt(deltaI.value||"0",10);
      if(!delta) { toast("Enter a non-zero delta"); return; }
      const reason = reasonI.value||null;
      const { data: session } = await supabase.auth.getUser();
      const admin_id = session?.user?.id || null;
      const { error } = await supabase.from('adjustments').insert({ player_id: p.id, delta, reason, admin_id });
      if(error){ toast("Failed: "+error.message); return; }
      toast(`Applied ${delta>0?'+':''}${delta} to ${p.nickname||p.id.slice(0,8)}`);
      await Promise.all([loadPlayers(showAll), loadLeaderboard()]);
    };
    tbody.appendChild(tr);
  });
}

function toast(msg){
  const t=document.getElementById('toast');
  t.innerText=msg;
  t.style.display='block';
  setTimeout(()=>t.style.display='none',3000);
}
</script>
</body>
</html>
