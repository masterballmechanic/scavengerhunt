
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Munchies Halloween Hunt</title>
  <style>
    body { background:#0d0d0d; color:#fff; font-family:sans-serif; margin:0; }
    header { background:#1a1a1a; padding:10px; display:flex; justify-content:space-around; }
    header button { background:#ff6600; border:none; padding:10px 20px; border-radius:6px; font-weight:bold; cursor:pointer; }
    header button.active { background:#ffaa33; }
    section { display:none; padding:20px; }
    section.active { display:block; }
    .toast { position:fixed; bottom:10px; right:10px; background:#333; padding:10px; border-radius:5px; }
    input, button, textarea { margin:5px 0; padding:8px; }
  </style>
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
</head>
<body>
  <header>
    <button onclick="show('play')" id="btn-play">Play</button>
    <button onclick="show('admin')" id="btn-admin">Admin</button>
    <button onclick="show('leaderboard')" id="btn-leaderboard">Leaderboard</button>
  </header>

  <section id="play" class="active">
    <h2>ðŸŽƒ Player View</h2>
    <label>Nickname: <input id="nickname" placeholder="Enter nickname"/></label>
    <button onclick="saveNickname()">Save</button>
    <div><button onclick="claimTag()">ðŸ‘» Log a token</button></div>
    <div id="progress"></div>
  </section>

  <section id="admin">
    <h2>ðŸ”‘ Admin Login</h2>
    <div id="admin-login">
      <input id="admin-email" placeholder="Email"/><br/>
      <button onclick="sendLogin()">Send OTP</button>
    </div>
    <div id="admin-otp" style="display:none;">
      <input id="admin-code" placeholder="Enter OTP Code"/><br/>
      <button onclick="verifyLogin()">Verify</button>
    </div>
    <div id="admin-panel" style="display:none;">
      <h3>Tags</h3>
      <div id="tag-list"></div>
      <h3>Live Finds</h3>
      <div id="live-finds"></div>
    </div>
  </section>

  <section id="leaderboard">
    <h2>ðŸ‘» Leaderboard</h2>
    <div id="leaders"></div>
  </section>

  <div id="toast" class="toast" style="display:none;"></div>

<script>
const SUPABASE_URL = "https://oeahpsbnazvijogyxedu.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9lYWhwc2JuYXp2aWpvZ3l4ZWR1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc2MzIxMDQsImV4cCI6MjA3MzIwODEwNH0.FFx6EfbVu2FGGdsfLHGAUASSfsek679Q1z5gDcYqaPE"; // replace with your real anon key
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

let playerId = localStorage.getItem('player_id');

async function ensurePlayer() {
  if (!playerId) {
    let { data, error } = await supabase.from('players').insert({}).select().single();
    if (!error && data) {
      playerId = data.id;
      localStorage.setItem('player_id', playerId);
    }
  }
}
ensurePlayer();

function show(view) {
  document.querySelectorAll('section').forEach(s => s.classList.remove('active'));
  document.getElementById(view).classList.add('active');
  document.querySelectorAll('header button').forEach(b=>b.classList.remove('active'));
  document.getElementById('btn-'+view).classList.add('active');
}

async function saveNickname(){
  const nickname = document.getElementById('nickname').value;
  if(!nickname) return;
  await supabase.from('players').update({nickname}).eq('id',playerId);
  toast("Nickname saved");
}

async function claimTag(){
  const code = prompt("Enter tag id (e.g., GRAVEYARD-01)");
  if(!code) return;
  await ensurePlayer();
  const { data, error } = await supabase.from('finds').insert({ player_id:playerId, tag_id:code }).select().single();
  if(error) toast("Error: "+error.message);
  else toast("Logged "+code);
}

function toast(msg){
  const t=document.getElementById('toast');
  t.innerText=msg;
  t.style.display='block';
  setTimeout(()=>t.style.display='none',3000);
}

async function loadLeaderboard(){
  // Fallback: simple aggregate if RPC leaderboard not defined
  const { data, error } = await supabase
    .from('finds')
    .select('player_id, tags(points)')
    .limit(50);
  if(error){ document.getElementById('leaders').innerText="Error "+error.message; return; }
  const scores = {};
  data.forEach(f=>{
    const pts = f.tags? f.tags.points : 0;
    scores[f.player_id] = (scores[f.player_id]||0)+pts;
  });
  const arr = Object.entries(scores).map(([id,pts])=>({id,pts})).sort((a,b)=>b.pts-a.pts);
  document.getElementById('leaders').innerHTML = arr.map((p,i)=>`<div>${i+1}. ${p.id.substring(0,5)} - ${p.pts} pts</div>`).join("");
}
setInterval(loadLeaderboard,15000);
loadLeaderboard();

// Admin login
async function sendLogin(){
  const email = document.getElementById('admin-email').value;
  const { error } = await supabase.auth.signInWithOtp({ email });
  if(error) toast("Error sending OTP: "+error.message);
  else { toast("Check your email for OTP"); document.getElementById('admin-otp').style.display='block'; }
}

async function verifyLogin(){
  const email = document.getElementById('admin-email').value;
  const code = document.getElementById('admin-code').value;
  const { data, error } = await supabase.auth.verifyOtp({ email, token: code, type: 'magiclink' });
  if(error) toast("Login failed: "+error.message);
  else { toast("Admin logged in"); document.getElementById('admin-panel').style.display='block'; }
}
</script>
</body>
</html>
