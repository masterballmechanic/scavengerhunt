<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Munchies Halloween Hunt</title>
  <style>
    body { background:#0d0d0d; color:#fff; font-family:sans-serif; margin:0; }
    header { background:#1a1a1a; padding:10px; display:flex; justify-content:space-around; }
    header button { background:#ff6600; border:none; padding:10px 20px; border-radius:6px; font-weight:bold; cursor:pointer; }
    header button.active { background:#ffaa33; }
    section { display:none; padding:20px; }
    section.active { display:block; }
    .toast { position:fixed; bottom:10px; right:10px; background:#333; padding:10px; border-radius:5px; }
    input, button, textarea { margin:5px 0; padding:8px; }
    .muted { color:#bbb; font-size:12px; }
  </style>
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
</head>
<body>
  <header>
    <button onclick="show('play')" id="btn-play">Play</button>
    <button onclick="show('admin')" id="btn-admin">Admin</button>
    <button onclick="show('leaderboard')" id="btn-leaderboard">Leaderboard</button>
  </header>

  <section id="play" class="active">
    <h2>ðŸŽƒ Player View</h2>
    <label>Nickname: <input id="nickname" placeholder="Enter nickname"/></label>
    <button onclick="saveNickname()">Save</button>
    <div><button onclick="claimTag()">ðŸ‘» Log a token</button></div>
    <div id="progress" class="muted"></div>
  </section>

  <section id="admin">
    <h2>ðŸ”‘ Admin Login</h2>
    <div id="admin-login">
      <input id="admin-email" placeholder="Email"/><br/>
      <button onclick="sendLogin()">Send OTP</button>
      <div class="muted">Make sure your Pages URL is in Supabase â†’ Auth â†’ URL Configuration (Site URL + Redirect URLs).</div>
    </div>
    <div id="admin-otp" style="display:none;">
      <input id="admin-code" placeholder="Enter 6-digit code"/><br/>
      <button onclick="verifyLogin()">Verify</button>
    </div>
    <div id="admin-panel" style="display:none;">
      <h3>Tags</h3>
      <div id="tag-list"></div>
      <h3>Live Finds</h3>
      <div id="live-finds"></div>
    </div>
  </section>

  <section id="leaderboard">
    <h2>ðŸ‘» Leaderboard</h2>
    <div id="leaders"></div>
  </section>

  <div id="toast" class="toast" style="display:none;"></div>

<script>
const SUPABASE_URL = "https://oeahpsbnazvijogyxedu.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9lYWhwc2JuYXp2aWpvZ3l4ZWR1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc2MzIxMDQsImV4cCI6MjA3MzIwODEwNH0.FFx6EfbVu2FGGdsfLHGAUASSfsek679Q1z5gDcYqaPE"; // baked-in anon public key
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

let playerId = localStorage.getItem('player_id');

async function ensurePlayer() {
  if (!playerId) {
    let { data, error } = await supabase.from('players').insert({}).select().single();
    if (error) { console.error(error); toast("Player create failed"); return; }
    playerId = data.id;
    localStorage.setItem('player_id', playerId);
  }
  loadProgress();
}
ensurePlayer();

function show(view) {
  document.querySelectorAll('section').forEach(s => s.classList.remove('active'));
  document.getElementById(view).classList.add('active');
  document.querySelectorAll('header button').forEach(b=>b.classList.remove('active'));
  document.getElementById('btn-'+view).classList.add('active');
  if(view==='leaderboard') loadLeaderboard();
}

async function saveNickname(){
  const nickname = document.getElementById('nickname').value;
  await supabase.from('players').update({nickname}).eq('id',playerId);
  toast("Nickname saved");
  loadLeaderboard();
}

async function claimTag(){
  const code = prompt("Enter tag id (e.g., GRAVEYARD-01)");
  if(!code) return;
  await ensurePlayer();
  const tag = await supabase.from('tags').select('*').eq('id', code).maybeSingle();
  if(!tag.data) return toast("Tag not found");
  const pts = tag.data.points || 0;
  const { error } = await supabase.from('finds').insert({ player_id:playerId, tag_id:code, score_awarded: pts });
  if(error) toast("Error: "+error.message);
  else { toast("Logged "+code+" (+"+pts+" pts)"); loadProgress(); loadLeaderboard(); }
}

async function loadProgress(){
  const tags = await supabase.from('tags').select('*').eq('active', true);
  const finds = await supabase.from('finds').select('tag_id, score_awarded').eq('player_id', playerId);
  const total = (tags.data||[]).length;
  const found = new Set((finds.data||[]).map(f=>f.tag_id)).size;
  const points = (finds.data||[]).reduce((a,f)=>a+(f.score_awarded||0),0);
  document.getElementById('progress').innerText = `Found: ${found} / ${total} â€¢ Points: ${points}`;
}

function toast(msg){
  const t=document.getElementById('toast');
  t.innerText=msg;
  t.style.display='block';
  setTimeout(()=>t.style.display='none',3000);
}

// Leaderboard (robust: handles numeric/uuid ids, checks errors, uses string keys)
async function loadLeaderboard(){
  const finds = await supabase.from('finds').select('player_id, score_awarded');
  if(finds.error) { console.error(finds.error); return; }
  const scores = new Map();
  (finds.data||[]).forEach(r=>{
    const key = String(r.player_id);
    scores.set(key,(scores.get(key)||0)+(r.score_awarded||0));
  });
  const ids = Array.from(scores.keys());
  if(ids.length===0) { document.getElementById('leaders').innerHTML = "<div class='muted'>No plays yet</div>"; return; }

  const players = await supabase.from('players').select('id,nickname').in('id', ids);
  let names = {};
  if(players.error) { console.warn("players read error:", players.error); }
  (players.data||[]).forEach(p=> names[String(p.id)] = p.nickname || "");

  const arr = ids.map(id=>({ id, name: names[id]||id.slice(0,8), pts: scores.get(id) }))
                 .sort((a,b)=>b.pts-a.pts).slice(0,20);
  document.getElementById('leaders').innerHTML = arr.map((r,i)=>`<div>{i+1}. <b>{r.name}</b> â€” {r.pts} pts</div>`).join("");
}

// Admin login (OTP)
async function sendLogin(){
  const email = document.getElementById('admin-email').value.trim();
  if(!email) return toast("Enter email");
  const { error } = await supabase.auth.signInWithOtp({ email, options: { emailRedirectTo: location.href } });
  if(error) toast("Error sending OTP: "+error.message);
  else { toast("Check your email for OTP"); document.getElementById('admin-otp').style.display='block'; }
}

async function verifyLogin(){
  const email = document.getElementById('admin-email').value.trim();
  const code = document.getElementById('admin-code').value.trim();
  if(!email || !code) return;
  const { data, error } = await supabase.auth.verifyOtp({ email, token: code, type: 'email' });
  if(error) toast("Login failed: "+error.message);
  else { toast("Admin logged in"); document.getElementById('admin-panel').style.display='block'; loadAdmin(); }
}

async function loadAdmin(){
  const tags = await supabase.from('tags').select('*').order('id');
  document.getElementById('tag-list').innerHTML = (tags.data||[]).map(t=>`<div>{t.id} â€” {t.label||''} ({t.points||0} pts)</div>`).join("");
  const finds = await supabase.from('finds').select('found_at, tag_id, score_awarded').order('found_at', { ascending:false }).limit(10);
  document.getElementById('live-finds').innerHTML = (finds.data||[]).map(f=>`<div>{new Date(f.found_at).toLocaleTimeString()} â€” {f.tag_id} (+{f.score_awarded})</div>`).join("");
}
</script>
</body>
</html>
