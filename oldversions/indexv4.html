<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Munchies Halloween Hunt</title>
  <style>
    :root { --panel:#151218; --line:#2b2233; --muted:#cfc7d9; --brand:#ff6a00; --brand2:#ffb347; --gold:#ffd700; --silver:#c0c0c0; --bronze:#cd7f32; }
    * { box-sizing: border-box }
    html, body { height: 100%; }
    body {
      margin:0; color:#fff; font-family:system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      background: url('backgroundhalloween.png') center center / cover no-repeat fixed;
    }
    body::before {
      content:""; position:fixed; inset:0;
      background:radial-gradient(ellipse at top, rgba(0,0,0,.55), rgba(0,0,0,.78) 60%);
      z-index:-1;
    }
    header { backdrop-filter: blur(4px); background:linear-gradient(90deg, rgba(10,8,12,.75), rgba(10,8,12,.35));
      padding:8px 12px; display:flex; align-items:center; gap:10px; position:sticky; top:0; z-index:5; border-bottom:1px solid var(--line); }
    .brand img { width:104px; height:auto; display:block; }
    .spacer { flex:1; }
    .tabs { display:flex; gap:8px; }
    .tabs button { background:var(--brand); border:none; padding:10px 16px; border-radius:999px; font-weight:800; cursor:pointer; box-shadow:0 6px 18px rgba(0,0,0,.25); }
    .tabs button.active { background:var(--brand2); color:#2b1600 }
    main { padding:18px; }
    section { display:none; } section.active { display:block; }
    .toast { position:fixed; bottom:12px; right:12px; background:#1a141f; border:1px solid var(--line); padding:10px 12px; border-radius:10px; box-shadow:0 8px 24px rgba(0,0,0,.35); display:none; }
    input, button, textarea, select { margin:6px 0; padding:10px 12px; border-radius:10px; border:1px solid var(--line); background:rgba(18,16,24,.85); color:#fff; }
    input::placeholder { color:#cabbdc; } .muted { color:var(--muted); font-size:12px; }
    .row { display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
    .warn { background:rgba(80,10,10,.6); border:1px solid #6b1c1c; color:#ffd0d0; padding:10px 12px; border-radius:10px; margin:8px 0; }
    .oktag { background:#112a17; border:1px solid #1e4a2a; color:#b4f3c6; padding:6px 10px; border-radius:999px; font-size:12px; display:inline-block }
    table { width:100%; border-collapse:collapse; margin-top:8px; }
    th, td { border-bottom:1px solid var(--line); padding:8px; text-align:left; vertical-align:middle; }
    td.right { text-align:right } .pill { background:#201826; border:1px solid var(--line); padding:4px 8px; border-radius:999px; font-size:12px; }
    .card { border:1px solid var(--line); background:rgba(18,16,24,.78); border-radius:14px; padding:12px; margin:16px 0; box-shadow:0 12px 36px rgba(0,0,0,.35); }
    .list { list-style:none; padding:0; margin:0 } .item { display:flex; justify-content:space-between; align-items:center; padding:10px 0; border-bottom:1px dashed var(--line) }
    .item:last-child { border-bottom:none }
    .podium { display:grid; grid-template-columns: 1fr 1fr 1fr; gap:12px; align-items:end; margin:8px 0 16px; }
    .podium .slot { position:relative; text-align:center; background:rgba(18,16,24,.88); border:1px solid var(--line); border-radius:12px 12px 6px 6px; box-shadow:0 10px 30px rgba(0,0,0,.35); padding:10px 8px; }
    .podium .slot .place { position:absolute; top:-10px; left:50%; transform:translateX(-50%); font-weight:900; font-size:12px; padding:4px 8px; border-radius:999px; background:#00000080; border:1px solid var(--line); }
    .podium .slot .name { font-weight:800; margin-top:6px; } .podium .slot .pts { font-size:12px; color:var(--muted); }
    .podium .gold { height:150px; border-top:6px solid var(--gold); } .podium .silver { height:130px; border-top:6px solid var(--silver); } .podium .bronze { height:110px; border-top:6px solid var(--bronze); }
    .podium .medal { font-size:18px; display:block; margin-bottom:4px; }
    .lb-rest .rowline { display:flex; justify-content:space-between; padding:8px 0; border-bottom:1px dashed var(--line); }
    .lb-rest .rank { width:26px; text-align:center; opacity:.85; }
    .two-col { display:grid; grid-template-columns:1fr; gap:16px; } @media (min-width: 900px) { .two-col { grid-template-columns: 1.2fr .8fr; } }
    .gallery { display:grid; grid-template-columns: repeat(3, 1fr); gap:10px; } @media (min-width: 520px) { .gallery { grid-template-columns: repeat(4, 1fr); } } @media (min-width: 820px) { .gallery { grid-template-columns: repeat(6, 1fr); } }
    .tile { position:relative; border-radius:12px; overflow:hidden; background:#0f0d12; border:1px solid var(--line); }
    .tile img { width:100%; height:100%; object-fit:cover; display:block; aspect-ratio: 1 / 1; filter: grayscale(100%) contrast(0.7) brightness(0.7); transition: filter .2s ease, transform .2s ease; }
    .tile.found img { filter: none; }
    .tile .cap { position:absolute; bottom:0; left:0; right:0; background:linear-gradient(180deg, transparent, rgba(0,0,0,.75)); padding:6px 8px; font-size:12px; }
    .tile .badge { position:absolute; top:6px; right:6px; background:#162a16; border:1px solid #2a5a2a; color:#b9f7c8; padding:4px 6px; font-size:10px; border-radius:999px; display:none; }
    .tile.found .badge { display:inline-block; }
  </style>
  <script src="https://unpkg.com/@supabase/supabase-js@2" defer></script>
  <script defer>
  (function(){
    const SUPABASE_URL = "https://oeahpsbnazvijogyxedu.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9lYWhwc2JuYXp2aWpvZ3l4ZWR1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc2MzIxMDQsImV4cCI6MjA3MzIwODEwNH0.FFx6EfbVu2FGGdsfLHGAUASSfsek679Q1z5gDcYqaPE";
    let supabaseClient;
    function ready(fn){ if(document.readyState!=='loading') fn(); else document.addEventListener('DOMContentLoaded', fn); }
    function $(id){ return document.getElementById(id); }
    function toast(msg){ const t=$('toast'); if(!t) return; t.innerText=msg; t.style.display='block'; setTimeout(()=>t.style.display='none',3000); }
    function badName(s){ if(!s) return true; const banned=["fuck","shit","bitch","cunt","asshole","bastard","dick","cock","pussy","twat","slut","whore","prick","bollocks","bugger","arse","damn","goddamn","hell","hitler","stalin","mussolini","putin","lenin","mao","kim jong","kim jong un","xi jinping","trump","donald trump","biden","joe biden","obama","barack","bush","reagan","saddam","bin laden","gaddafi","pol pot","castro","netanyahu","modi","erdogan","bolsonaro","assad","duarte","mohammed bin"]; const t=s.toLowerCase(); return banned.some(w=>t.includes(w)); }
    function cleanName(s){ return (s||"").replace(/\s+/g," ").trim(); }
    function normalizePhone(input){ if(!input) return ""; const digits=(""+input).replace(/\D+/g,""); if(digits.length===10) return "+1"+digits; if(digits.length===11 && digits.startsWith("1")) return "+"+digits; if(((input+"").startsWith("+") && digits.length>=10 && digits.length<=15)) return "+"+digits; return ""; }
    function isValidPhone(input){ return !!normalizePhone(input); }
    let playerId=null, incomingTag=null;
    function activate(view){ document.querySelectorAll('section').forEach(s=>s.classList.remove('active')); $(view).classList.add('active'); document.querySelectorAll('.tabs button').forEach(b=>b.classList.remove('active')); $('btn-'+view).classList.add('active'); if(view==='leaderboard') loadLeaderboard(); }
    window.show=activate;
    ready(async function init(){
      supabaseClient = window.supabase.createClient(SUPABASE_URL,SUPABASE_KEY);
      const qs=new URLSearchParams(location.search);
      incomingTag=(qs.get('tag')||'').trim().toUpperCase();
      const stored=localStorage.getItem('player_id');
      if(stored) playerId=stored;
      if(incomingTag) localStorage.setItem('pending_tag', incomingTag);
      await renderPlay();
      await loadProgress(); await loadMyFinds(); await renderGallery();
      if(localStorage.getItem('pending_tag')) toast("Scan captured ‚Äî finish your profile to log it.");
    });
    async function fetchPlayer(id){ return supabaseClient.from('players').select('id,nickname,phone').eq('id',id).maybeSingle(); }
    async function renderPlay(){
      let data=null;
      if(playerId){ const res=await fetchPlayer(playerId); if(res.data) data=res.data; else playerId=null; }
      const hasId = !!playerId;
      if(!hasId){
        $('profileBanner').style.display='block'; $('profileEditor').style.display='block'; $('profileSummary').style.display='none';
        $('nickname').value=''; $('phone').value='';
        const p = localStorage.getItem('pending_tag'); const note=$('pendingNote'); if(p){ note.innerText=`You scanned: ${p}. Save your profile to log it.`; note.style.display='block'; } else note.style.display='none';
        return;
      }
      const nickname = cleanName(data.nickname||""); const phoneOk = !!data.phone && isValidPhone(data.phone);
      const nickOk = !!nickname && nickname.length>=2 && !badName(nickname); const ok = phoneOk && nickOk;
      $('profileBanner').style.display = ok ? 'none' : 'block';
      $('profileEditor').style.display = ok ? 'none' : 'block';
      $('profileSummary').style.display = ok ? 'block' : 'none';
      if(ok) $('summaryNick').innerText = nickname; else { $('nickname').value=nickname; $('phone').value=data.phone||""; }
    }
    async function findPlayerIdByPhoneE164(e164){
      if(!e164) return null;
      const q = await supabaseClient.from('players').select('id, nickname, phone').order('created_at',{ascending:true});
      const rows = q.data||[];
      const match = rows.find(p => normalizePhone(p.phone)===e164);
      return match ? match.id : null;
    }
    async function tryAutoClaim(){
      const p=(localStorage.getItem('pending_tag')||'').trim().toUpperCase();
      if(!p || !playerId) return;
      const prior=await supabaseClient.from('finds').select('id').eq('player_id',playerId).eq('tag_id',p).maybeSingle();
      if(prior.data){ localStorage.removeItem('pending_tag'); history.replaceState({}, "", location.pathname+"?v=play"); return; }
      const tag=await supabaseClient.from('tags').select('*').eq('id',p).maybeSingle();
      if(!tag.data || !tag.data.active){ toast("Invalid or inactive token"); localStorage.removeItem('pending_tag'); history.replaceState({}, "", location.pathname+"?v=play"); return; }
      const pts=tag.data.points||0;
      const { error }=await supabaseClient.from('finds').insert({ player_id:playerId, tag_id:p, score_awarded:pts });
      if(error) toast("Log failed: "+error.message); else { toast(`Logged ${p} (+${pts} pts)`); await loadProgress(); await loadMyFinds(); await renderGallery(); }
      localStorage.removeItem('pending_tag'); history.replaceState({}, "", location.pathname+"?v=play");
    }
    window.saveProfile = async function saveProfile(){
      let nickname = cleanName(document.getElementById('nickname').value);
      const phoneRaw = document.getElementById('phone').value.trim();
      const e164 = normalizePhone(phoneRaw);
      if(!nickname){ toast("Nickname is required"); return; }
      if(nickname.length<2){ toast("Nickname must be at least 2 chars"); return; }
      if(badName(nickname)){ toast("Please choose a different nickname"); return; }
      if(!isValidPhone(phoneRaw)){ toast("Enter a valid phone number"); return; }
      const existingId = await findPlayerIdByPhoneE164(e164);
      if(existingId){
        playerId = existingId; localStorage.setItem('player_id', playerId);
        await supabaseClient.from('players').update({ nickname, phone: e164 }).eq('id', playerId);
        document.getElementById('profileOk').style.display='inline-block'; setTimeout(()=>document.getElementById('profileOk').style.display='none',1200);
        await renderPlay(); await tryAutoClaim(); await loadLeaderboard(); return;
      }
      const ins = await supabaseClient.from('players').insert({ nickname, phone: e164 }).select().single();
      if(ins.error) return toast("Save failed: "+ins.error.message);
      playerId = ins.data.id; localStorage.setItem('player_id', playerId);
      document.getElementById('profileOk').style.display='inline-block'; setTimeout(()=>document.getElementById('profileOk').style.display='none',1200);
      await renderPlay(); await tryAutoClaim(); await loadLeaderboard();
    }
    async function loadProgress(){
      const tags = await supabaseClient.from('tags').select('*').eq('active', true);
      const finds = await supabaseClient.from('finds').select('tag_id, score_awarded').eq('player_id', playerId);
      const total=(tags.data||[]).length; const found=new Set((finds.data||[]).map(f=>f.tag_id)).size; const points=(finds.data||[]).reduce((a,f)=>a+(f.score_awarded||0),0);
      document.getElementById('progress').innerText = `Found: ${found} / ${total} ‚Ä¢ Points: ${points}`;
    }
    async function loadMyFinds(){
      const { data, error }=await supabaseClient.from('finds').select('found_at, tag_id, tags(label, points)').eq('player_id',playerId).order('found_at',{ascending:false});
      const list=document.getElementById('myFinds'); const empty=document.getElementById('noFinds'); list.innerHTML="";
      if(error || !data || !data.length){ empty.style.display='block'; return; } empty.style.display='none';
      data.forEach(r=>{ const li=document.createElement('li'); li.className='item'; const label=(r.tags&&r.tags.label)?r.tags.label:r.tag_id; const pts=(r.tags&&typeof r.tags.points!=='undefined')?r.tags.points:'';
        li.innerHTML=`<span><b>${label}</b> <span class="muted">(${r.tag_id})</span></span><span class="muted">${new Date(r.found_at).toLocaleTimeString()}${pts!==''?` ‚Ä¢ +${pts} pts`:''}</span>`; list.appendChild(li); });
    }
    async function renderGallery(){
      const tg=await supabaseClient.from('tags').select('id,label,image_url,active,points').order('id');
      if(tg.error) return (document.getElementById('gallery').innerHTML='<div class="muted">Error loading gallery</div>');
      const my=await supabaseClient.from('finds').select('tag_id').eq('player_id',playerId);
      const foundSet=new Set((my.data||[]).map(r=>r.tag_id));
      const nodes=(tg.data||[]).map(t=>{ const found=foundSet.has(t.id); const src=t.image_url||`/images/${String(t.id).toUpperCase()}.jpg`; const label=t.label||t.id;
        return `<div class="tile ${found?'found':''}" title="${label}"><img loading="lazy" src="${src}" alt="${label}"/><span class="badge">‚úì Found</span><div class="cap"><b>${label}</b> <span class="muted">(${t.points||0} pts)</span></div></div>`; }).join('');
      document.getElementById('gallery').innerHTML = nodes || '<div class="muted">No tags added yet.</div>';
    }
    async function loadLeaderboard(){
      const finds=await supabaseClient.from('finds').select('player_id, score_awarded'); if(finds.error) return (document.getElementById('leaders').innerHTML="<div class='muted'>Error loading leaderboard</div>");
      const scores=new Map(); (finds.data||[]).forEach(r=>{ const k=String(r.player_id); scores.set(k,(scores.get(k)||0)+(r.score_awarded||0)); });
      const adj=await supabaseClient.from('adjustments').select('player_id, delta'); if(!adj.error) (adj.data||[]).forEach(a=>{ const k=String(a.player_id); scores.set(k,(scores.get(k)||0)+(a.delta||0)); });
      const ids=Array.from(scores.keys()); if(!ids.length) return (document.getElementById('leaders').innerHTML="<div class='muted'>No plays yet</div>");
      const players=await supabaseClient.from('players').select('id,nickname').in('id',ids); const names={}; (players.data||[]).forEach(p=>names[String(p.id)]=p.nickname||p.id.slice(0,8));
      const arr=ids.map(id=>({id,name:names[id]||id.slice(0,8),pts:scores.get(id)})).sort((a,b)=>b.pts-a.pts);
      const gold=arr[0],silver=arr[1],bronze=arr[2];
      document.getElementById('leaders').innerHTML = `
        <div class="podium card">
          <div class="slot silver"><span class="place">2ND</span><span class="medal">ü•à</span><div class="name">${silver?silver.name:'‚Äî'}</div><div class="pts">${silver?silver.pts:0} pts</div></div>
          <div class="slot gold"><span class="place">1ST</span><span class="medal">ü•á</span><div class="name">${gold?gold.name:'‚Äî'}</div><div class="pts">${gold?gold.pts:0} pts</div></div>
          <div class="slot bronze"><span class="place">3RD</span><span class="medal">ü•â</span><div class="name">${bronze?bronze.name:'‚Äî'}</div><div class="pts">${bronze?bronze.pts:0} pts</div></div>
        </div>`
        + arr.slice(3,50).map((r,i)=>`<div class="card lb-rest"><div class="rowline"><div><span class="rank">${i+4}</span> <b>${r.name}</b></div><div>${r.pts} pts</div></div></div>`).join('');
    }
  })();
  </script>
</head>
<body>
  <header>
    <a class="brand" href="/"><img src="logo.png" alt="Munchies Logo" /></a>
    <div class="spacer"></div>
    <nav class="tabs">
      <button onclick="show('play')" id="btn-play" class="active">Play</button>
      <button onclick="show('leaderboard')" id="btn-leaderboard">Leaderboard</button>
    </nav>
  </header>

  <main>
    <section id="play" class="active">
      <h2>üéÉ Player</h2>
      <div id="profileBanner" class="warn" style="display:none;">üìù Nickname <b>and</b> üì± Phone are required. Enter both and hit <b>Save</b> to continue.</div>

      <div id="profileEditor" class="card" style="display:none;">
        <div class="row">
          <input id="nickname" placeholder="Nickname (required)" maxlength="24" />
          <input id="phone" placeholder="Phone (e.g., 555-123-4567 or +15551234567)" inputmode="tel"/>
          <button onclick="saveProfile()">Save</button>
          <span id="profileOk" class="oktag" style="display:none;">Saved</span>
        </div>
        <div id="pendingNote" class="muted" style="display:none;"></div>
      </div>

      <div id="profileSummary" class="card" style="display:none;">
        <div><b>Nickname:</b> <span id="summaryNick"></span></div>
        <div class="muted">Tokens auto-log by scanning NFC/QR on this device.</div>
      </div>

      <div id="progress" class="muted"></div>

      <div class="card">
        <h3>üé¨ Clue Gallery</h3>
        <div id="gallery" class="gallery"></div>
        <div class="muted">Images are grayscale until you find the matching tag.</div>
      </div>

      <div class="card">
        <h3>Your Finds</h3>
        <ul id="myFinds" class="list"></ul>
        <div id="noFinds" class="muted">No finds yet. Scan your first token!</div>
      </div>
    </section>

    <section id="leaderboard">
      <h2>üëª Leaderboard</h2>
      <div id="leaders"></div>
    </section>
  </main>

  <div id="toast" class="toast"></div>
</body>
</html>